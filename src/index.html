<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RENEGADE KERNEL</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <link rel="manifest" href="manifest.json">
    <style>
        body {
            background-color: #0d0d0d;
            color: #00f2fe;
            font-family: 'JetBrains Mono', monospace;
        }
        .orbitron { font-family: 'Orbitron', sans-serif; }
        .neon-border { border: 1px solid #7b2ff7; box-shadow: 0 0 10px #7b2ff7; }
        .neon-text { text-shadow: 0 0 5px #00f2fe; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .sidebar.closed { transform: translateX(-100%); }
        .chat-container::-webkit-scrollbar { width: 5px; }
        .chat-container::-webkit-scrollbar-thumb { background: #7b2ff7; border-radius: 10px; }
    </style>
</head>
<body class="h-screen flex overflow-hidden">

    <!-- SIDEBAR (Chat History) -->
    <div id="sidebar" class="sidebar fixed inset-y-0 left-0 w-64 bg-[#1a1a1a] border-r border-[#7b2ff7] z-50 closed lg:static lg:transform-none">
        <div class="p-4 flex flex-col h-full">
            <h2 class="orbitron text-xl font-bold mb-6 neon-text">CHATS</h2>
            <button onclick="newChat()" class="mb-4 w-full p-2 bg-[#7b2ff7] text-white orbitron font-bold hover:bg-[#9d50bb] transition">NEW UPLINK</button>
            <div id="session-list" class="flex-1 overflow-y-auto space-y-2">
                <!-- Sessions will be loaded here -->
            </div>
            <div class="mt-auto pt-4 border-t border-[#333]">
                <input type="password" id="apiKey" placeholder="API KEY" class="w-full bg-black border border-[#7b2ff7] p-2 text-xs mb-2">
                <select id="modelSelect" class="w-full bg-black border border-[#7b2ff7] p-2 text-xs"></select>
            </div>
        </div>
    </div>

    <!-- MAIN INTERFACE -->
    <div class="flex-1 flex flex-col min-w-0">
        <!-- HEADER -->
        <header class="p-4 border-b border-[#7b2ff7] flex justify-between items-center bg-[#0d0d0d]">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="lg:hidden text-[#7b2ff7] text-2xl">â˜°</button>
                <h1 class="orbitron text-2xl font-bold neon-text">RENEGADE_KERNEL_v1.0</h1>
            </div>
            <div class="hidden sm:block text-xs text-[#7b2ff7] opacity-70 uppercase tracking-widest">Operator Uplink Active</div>
        </header>

        <!-- CHAT AREA -->
        <main id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-4 chat-container bg-[#050505]">
            <div class="text-center p-10 opacity-50">
                <p class="orbitron text-xl">WAKE UP, OPERATOR...</p>
                <p class="text-xs mt-2">Initialize system by sending a command.</p>
            </div>
        </main>

        <!-- INPUT AREA -->
        <footer class="p-4 bg-[#0d0d0d] border-t border-[#7b2ff7]">
            <div class="max-w-4xl mx-auto flex gap-4">
                <input type="text" id="userInput" placeholder="ENTER COMMAND..." 
                    class="flex-1 bg-black border border-[#7b2ff7] p-3 focus:outline-none focus:ring-1 focus:ring-[#00f2fe]"
                    onkeypress="if(event.key === 'Enter') sendMessage()">
                <button onclick="sendMessage()" class="bg-[#7b2ff7] px-6 py-2 orbitron font-bold hover:bg-[#9d50bb] transition text-white">EXEC</button>
            </div>
        </footer>
    </div>

    <script>
        let currentSessionId = 'session_' + Date.now();
        let chatHistory = [];

        async function loadSessions() {
            const res = await fetch('/api/sessions');
            const sessions = await res.json();
            const list = document.getElementById('session-list');
            list.innerHTML = '';
            sessions.reverse().forEach(s => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-2 text-sm border-b border-[#333] hover:bg-[#222] truncate";
                btn.innerText = s.title;
                btn.onclick = () => loadSession(s.id);
                list.appendChild(btn);
            });
        }

        async function loadSession(id) {
            const res = await fetch(`/api/sessions/${id}`);
            const data = await res.json();
            currentSessionId = id;
            chatHistory = data.messages;
            renderHistory();
            if(window.innerWidth < 1024) toggleSidebar();
        }

        function newChat() {
            currentSessionId = 'session_' + Date.now();
            chatHistory = [];
            document.getElementById('chat-container').innerHTML = '';
            if(window.innerWidth < 1024) toggleSidebar();
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('closed');
        }

        function renderHistory() {
            const container = document.getElementById('chat-container');
            container.innerHTML = '';
            chatHistory.forEach(msg => {
                appendMessage(msg.role === 'user' ? 'OPERATOR' : 'KERNEL', msg.parts[0].text, msg.role === 'user');
            });
        }

        function appendMessage(sender, text, isUser) {
            const container = document.getElementById('chat-container');
            const div = document.createElement('div');
            div.className = `p-3 rounded-lg ${isUser ? 'bg-[#1a1a1a] ml-auto max-w-[80%]' : 'bg-[#0d0d0d] border border-[#7b2ff7] mr-auto max-w-[80%]'}`;
            div.innerHTML = `<span class="text-[10px] orbitron ${isUser ? 'text-[#7b2ff7]' : 'text-[#00f2fe]'}">${sender}</span><p class="mt-1">${text}</p>`;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('userInput');
            const text = input.value.trim();
            const apiKey = document.getElementById('apiKey').value;
            const model = document.getElementById('modelSelect').value;

            if (!text || !apiKey) return;

            appendMessage('OPERATOR', text, true);
            input.value = '';

            try {
                const res = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, apiKey, model, history: chatHistory })
                });
                const data = await res.json();

                if (data.reply) {
                    appendMessage('KERNEL', data.reply, false);
                    chatHistory.push({ role: 'user', parts: [{ text: text }] });
                    chatHistory.push({ role: 'model', parts: [{ text: data.reply }] });
                    
                    // Save session
                    await fetch('/api/sessions/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            id: currentSessionId, 
                            title: chatHistory[0].parts[0].text.substring(0, 30), 
                            messages: chatHistory 
                        })
                    });
                    loadSessions();
                }
            } catch (e) {
                appendMessage('ERROR', 'Link unstable: ' + e.message, false);
            }
        }

        // Initialize models
        async function init() {
            const apiKey = localStorage.getItem('renegade_key');
            if(apiKey) document.getElementById('apiKey').value = apiKey;
            
            document.getElementById('apiKey').onchange = (e) => {
                localStorage.setItem('renegade_key', e.target.value);
                fetchModels(e.target.value);
            };

            if(apiKey) fetchModels(apiKey);
            loadSessions();
        }

        async function fetchModels(key) {
            const res = await fetch('/api/models', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ apiKey: key })
            });
            const data = await res.json();
            const select = document.getElementById('modelSelect');
            select.innerHTML = data.models.map(m => `<option value="${m.id}">${m.name}</option>`).join('');
        }

        init();
    </script>
</body>
</html>
